<%
  issues_display_limit = LastSeenIssuesPluginSettings.get_setting(:number_for_last_displayed_issues_setting)
  # blank setting or not a number, default 5
  if (issues_display_limit.blank? || !(/\A\d+\z/).match(issues_display_limit))
    issues_display_limit = 5
  end
%>

<%= javascript_tag do %>
    var last_seen_issues_key = "last_seen_issues";
    var last_seen_issues_queue = [];
    var issue_id = <%= @issue.id %>
    var issues_display_limit = <%= issues_display_limit %>
    if (localStorage.getItem(last_seen_issues_key)) {
        last_seen_issues_queue = JSON.parse(localStorage.getItem(last_seen_issues_key));
    }

    // if id already exists remove it, will be added at the top of queue because becomes latest issue seen
    if (last_seen_issues_queue.includes(issue_id)) {
        var index_of_existing_id = last_seen_issues_queue.indexOf(issue_id);
        last_seen_issues_queue.splice(index_of_existing_id, 1);
    }

    // add id as first element
    last_seen_issues_queue.unshift(issue_id);

    // remove last extra elements if setting limit is exceded
    if (last_seen_issues_queue.length > issues_display_limit) {
        var number_of_deleted_elements = last_seen_issues_queue.length - issues_display_limit;
        last_seen_issues_queue.splice(last_seen_issues_queue.length - number_of_deleted_elements);
    }
    
    localStorage.setItem(last_seen_issues_key, JSON.stringify(last_seen_issues_queue));
<% end %>